<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Configuración de Cuenta - FlashBuyX</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variables CSS para consistencia de colores y fuentes */
        :root {
            --primary-color: #4285F4; /* Azul de Google, vibrante y limpio */
            --primary-light: #66A3FF; /* Azul más claro para hover */
            --primary-dark: #1A5FB4; /* Azul más oscuro para contraste */
            --secondary-color: #616A6B; /* Gris pizarra oscuro para elementos secundarios */
            --secondary-light: #ABB2B9; /* Gris más claro para texto y bordes secundarios */
            --text-color-dark: #2C3E50; /* Azul oscuro casi negro para textos principales */
            --text-color-medium: #5D6D7E; /* Gris azulado medio para texto secundario */
            --text-color-light: #9FA7AE; /* Gris claro para texto informativo */
            --border-color: #EBF1F5; /* Gris muy claro para bordes sutiles */
            --bg-color-light: #F8F9FA; /* Fondo muy claro, casi blanco */
            --success-color: #28A745; /* Verde estándar para éxito */
            --error-color: #DC3545; /* Rojo estándar para error */
            --info-color: #17A2B8; /* Azul cian para información */
            --warning-color: #FFC107; /* Naranja para advertencia */
            --spacing-unit: 1rem; /* Unidad base para espaciado */
        }

        /* Estilos Base (Mobile First) */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            /* Fondo con un degradado suave y sutil */
            background: linear-gradient(135deg, #f0f4f7 0%, #e8edf1 100%); /* Tonos de gris azulado muy claros */
            color: var(--text-color-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alineación superior para mejor visualización de scroll en móvil */
            padding: var(--spacing-unit);
            box-sizing: border-box; /* Asegura que el padding no cause desbordamiento */
        }

        .container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); /* Sombra ligeramente más profunda */
            padding: calc(var(--spacing-unit) * 1.5); /* 1.5rem */
            width: 100%;
            max-width: 500px; /* Limite de ancho para que no se extienda demasiado en pantallas grandes */
            margin-top: var(--spacing-unit); /* Espacio arriba del contenedor */
            position: relative;
        }

        #backArrow {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: background 0.3s, transform 0.2s;
            z-index: 10;
        }
        #backArrow:hover {
            background: var(--primary-light);
            transform: scale(1.05);
        }
        #backArrow svg {
            width: 18px;
            height: 18px;
            fill: var(--primary-color);
            transition: fill 0.3s;
        }
        #backArrow:hover svg {
            fill: white;
        }

        h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-color-dark);
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            font-size: 1.8rem; /* Tamaño de fuente responsivo */
            text-align: center; /* Centrar el título */
        }

        .section {
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            padding: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #fff; /* Mantener secciones blancas para contraste */
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); /* Sombra muy sutil para secciones */
        }

        .section-title {
            font-weight: 600;
            margin-bottom: var(--spacing-unit);
            color: var(--text-color-medium);
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: var(--spacing-unit);
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color-medium);
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            color: var(--text-color-dark);
            background-color: #fff;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.25); /* Sombra azul para el foco, más opaca */
        }

        /* --- Estilo para el campo de email "bloqueado" --- */
        input[readonly] {
            background-color: var(--bg-color-light); /* Fondo más claro para indicar lectura */
            cursor: default;
            border-color: var(--border-color); /* Borde más claro */
            opacity: 0.9; /* Ligeramente transparente */
        }

        .password-input-wrapper {
            position: relative;
            width: 100%;
        }

        .password-input-wrapper input {
            padding-right: 2.5rem; /* Espacio para el icono */
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--secondary-light);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .toggle-password:hover {
            color: var(--primary-color);
        }

        .toggle-password svg {
            width: 20px;
            height: 20px;
            fill: currentColor; /* Usa el color del padre (toggle-password) */
        }

        /* ESTILOS DE BOTONES MEJORADOS */
        button {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s, box-shadow 0.3s ease;
            font-size: 1rem;
            margin-top: 0.5rem;
            outline: none; /* Eliminar el contorno por defecto */
        }

        button:focus {
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.4); /* Anillo de foco sutil */
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.2); /* Sombra inicial */
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px); /* Elevación más notable */
            box-shadow: 0 8px 18px rgba(66, 133, 244, 0.35); /* Sombra más grande al hover */
        }
        .btn-primary:active {
            transform: translateY(0); /* Efecto de "presionado" */
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.2);
            background-color: var(--primary-dark); /* Mantener oscuro al presionar */
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(97, 106, 107, 0.1); /* Sombra inicial */
        }
        .btn-secondary:hover {
            background-color: var(--secondary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(97, 106, 107, 0.25);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(97, 106, 107, 0.1);
            background-color: var(--secondary-light);
        }

        /* Estilo específico para el botón de eliminar cuenta */
        button.btn-delete { /* Añadir una clase btn-delete al botón */
            background-color: var(--error-color);
            color: white;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }
        button.btn-delete:hover {
            background-color: #C82333; /* Rojo ligeramente más oscuro */
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(220, 53, 69, 0.35);
        }
        button.btn-delete:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.2);
            background-color: #C82333;
        }


        .btn-link {
            background: none;
            border: none;
            color: var(--info-color);
            text-decoration: underline;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            width: auto;
            margin-top: 1rem;
            transition: color 0.2s ease;
        }
        .btn-link:hover {
            color: var(--primary-dark);
            text-decoration: none; /* Quitar subrayado en hover para un efecto limpio */
        }
        .btn-link:focus {
            box-shadow: none; /* No queremos sombra para los links */
            outline: 2px dotted var(--primary-color); /* Foco con puntos para accesibilidad */
            outline-offset: 2px;
        }
        .btn-link:active {
            color: var(--primary-dark);
        }


        .message {
            margin-top: var(--spacing-unit);
            padding: 0.8rem;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
            text-align: left;
        }
        .message.success {
            background-color: rgba(40, 167, 69, 0.1); /* Verde con opacidad */
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        .message.error {
            background-color: rgba(220, 53, 69, 0.1); /* Rojo con opacidad */
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        .message.info {
            background-color: rgba(23, 162, 184, 0.1); /* Azul cian con opacidad */
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }
        .message.warning {
            background-color: rgba(255, 193, 7, 0.1); /* Naranja para advertencia */
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .dialog-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .dialog-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        .dialog-box p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--text-color-dark);
        }
        .dialog-actions button {
            width: 48%; /* Para botones en fila */
            margin: 0.5rem 1%;
        }

        /* Secciones ocultas por defecto */
        .hidden-section {
            display: none;
        }

        /* Estado de error para inputs */
        input.error {
            border-color: var(--error-color);
        }

        /* NEW: Estilos para la sección de opciones de desarrollador */
        #developerOptionsSection .form-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        #developerOptionsSection .form-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        #developerOptionsSection .form-group label {
            margin-bottom: 0;
            font-weight: 400;
            color: var(--text-color-dark);
            font-size: 1rem;
            flex-grow: 1;
        }

        #developerOptionsSection .form-group input[type="checkbox"] {
            width: auto;
            margin-left: 1rem;
            transform: scale(1.2); /* Hacer el checkbox un poco más grande */
        }
        /* Fin NEW */

        /* Media Queries */
        /* Tabletas y escritorios pequeños */
        @media (min-width: 768px) {
            body {
                padding: calc(var(--spacing-unit) * 2);
                align-items: center; /* Centrar verticalmente en pantallas más grandes */
            }
            .container {
                padding: calc(var(--spacing-unit) * 2.5); /* Más padding en pantallas más grandes */
                margin-top: 0; /* No se necesita margen superior si está centrado */
            }
            h2 {
                font-size: 2.2rem;
            }
            .section-title {
                font-size: 1.3rem;
            }
            input[type="text"],
            input[type="email"],
            input[type="password"] {
                padding: 1rem;
            }
            button {
                padding: 1rem;
                font-size: 1.1rem;
            }
            .message {
                font-size: 1rem;
            }
        }

        /* Escritorios más grandes */
        @media (min-width: 1024px) {
            .container {
                max-width: 600px;
            }
            h2 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="backArrow" onclick="goBack()" tabindex="0">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>

        <h2 id="mainTitle">Configuración de Cuenta</h2>

        <section id="userProfileSection" class="section">
            <h3 class="section-title">Información de Perfil</h3>
            <div class="form-group">
                <label for="displayNombre">Nombre:</label>
                <input type="text" id="displayNombre" readonly>
            </div>
            <div class="form-group">
                <label for="displayApellido">Apellido:</label>
                <input type="text" id="displayApellido" readonly>
            </div>
            <div class="form-group">
                <label for="displayEmail">Correo Electrónico:</label>
                <input type="email" id="displayEmail" readonly>
            </div>
            <button class="btn-primary" onclick="showProfileEditSection()" tabindex="0">Editar Perfil</button>
        </section>

        <section id="userProfileEditSection" class="section hidden-section">
            <h3 class="section-title">Editar Información de Perfil</h3>
            <div class="form-group">
                <label for="editNombre">Nombre:</label>
                <input type="text" id="editNombre">
            </div>
            <div class="form-group">
                <label for="editApellido">Apellido:</label>
                <input type="text" id="editApellido">
            </div>
            <button class="btn-primary" onclick="saveProfileChanges()" tabindex="0">Guardar Cambios</button>
            <button class="btn-secondary" onclick="cancelProfileEdit()" tabindex="0">Cancelar</button>
        </section>

        <section id="securitySection" class="section">
            <h3 class="section-title">Seguridad de la Cuenta</h3>
            <button class="btn-secondary" onclick="showChangePasswordFlow()" tabindex="0">Cambiar Contraseña</button>
            <button class="btn-secondary" onclick="showChangeEmailFlow()" tabindex="0">Cambiar Correo Electrónico</button>
            <button class="btn-secondary" onclick="iniciarVerificacionCorreo()" tabindex="0">Verificar Correo Actual</button>
        </section>

        <section id="changePasswordSection" class="section hidden-section">
            <h3 class="section-title">Cambiar Contraseña</h3>
            <div class="form-group password-input-wrapper">
                <label for="currentPassword">Contraseña Actual:</label>
                <input type="password" id="currentPassword" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('currentPassword')" tabindex="0">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <div class="form-group password-input-wrapper">
                <label for="newPassword">Nueva Contraseña:</label>
                <input type="password" id="newPassword" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('newPassword')" tabindex="0">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <div class="form-group password-input-wrapper">
                <label for="confirmNewPassword">Confirmar Nueva Contraseña:</label>
                <input type="password" id="confirmNewPassword" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('confirmNewPassword')" tabindex="0">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <button class="btn-primary" onclick="changePassword()" tabindex="0">Cambiar Contraseña</button>
            <button class="btn-secondary" onclick="cancelChangePassword()" tabindex="0">Cancelar</button>
            <button class="btn-link" onclick="showForgotPasswordFlow()" tabindex="0">¿Olvidaste tu contraseña?</button>
        </section>

        <section id="verificationEmailSection" class="section hidden-section">
            <h3 class="section-title">Verificar Correo Electrónico Actual</h3>
            <p>El código de verificación será enviado a la dirección:</p>
            <p id="emailToVerifyDisplay" style="font-weight: bold; margin-bottom: 1rem;"></p>
            <button class="btn-primary" id="sendVerificationCodeBtn" onclick="enviarCodigoVerificacionActual()" tabindex="0">Enviar Código de Verificación</button>
            <p style="margin-top: 1rem;">Una vez enviado, ingréselo a continuación:</p>
            <div class="form-group">
                <label for="emailVerificationCode">Código de Verificación:</label>
                <input type="text" id="emailVerificationCode" maxlength="6" required>
            </div>
            <button class="btn-primary" onclick="verificarCodigoCorreo()" tabindex="0">Verificar Código</button>
            <button class="btn-secondary" onclick="cancelarVerificacionCorreo()" tabindex="0">Cancelar</button>
        </section>

        <section id="changeEmailSection" class="section hidden-section">
            <h3 class="section-title">Cambiar Correo Electrónico</h3>
            <p>Ingrese su nuevo correo electrónico. Deberá presionar 'Enviar Código' para recibir un código de verificación en esta dirección.</p>
            <div class="form-group">
                <label for="newEmail">Nuevo Correo Electrónico:</label>
                <input type="email" id="newEmail" placeholder="nuevo.correo@example.com" required>
            </div>
            <button class="btn-primary" id="sendNewEmailCodeBtn" onclick="enviarCodigoNuevoCorreo()" tabindex="0">Enviar Código de Verificación</button>
            <p style="margin-top: 1rem;">Una vez enviado, ingréselo a continuación:</p>
            <div class="form-group">
                <label for="newEmailVerificationCode">Código de Verificación:</label>
                <input type="text" id="newEmailVerificationCode" maxlength="6" required>
            </div>
            <button class="btn-primary" onclick="verificarCodigoNuevoCorreo()" tabindex="0">Verificar Código</button>
            <button class="btn-secondary" onclick="cancelChangeEmail()" tabindex="0">Cancelar</button>
        </section>

        <section id="verifyNewEmailSection" class="section hidden-section">
            <h3 class="section-title">Verificar Nuevo Correo Electrónico</h3>
            <p>Se ha enviado un código de verificación al nuevo correo electrónico. Por favor, ingréselo a continuación:</p>
            <div class="form-group">
                <label for="newEmailVerificationCode">Código de Verificación:</label>
                <input type="text" id="newEmailVerificationCode" maxlength="6" required>
            </div>
            <button class="btn-primary" onclick="verificarCodigoNuevoCorreo()" tabindex="0">Verificar Código</button>
            <button class="btn-secondary" onclick="cancelVerifyNewEmail()" tabindex="0">Cancelar</button>
        </section>

        <section id="forgotPasswordEmailSection" class="section hidden-section">
            <h3 class="section-title">Recuperar Contraseña</h3>
            <p>El código de recuperación será enviado al correo electrónico de tu cuenta.</p>
            <div class="form-group">
                <label for="forgotEmail">Correo Electrónico:</label>
                <input type="email" id="forgotEmail" readonly required>
            </div>
            <button class="btn-primary" id="sendRecoveryCodeBtn" onclick="enviarCodigoRecuperacion()" tabindex="0">Enviar Código de Recuperación</button>
            <p style="margin-top: 1rem;">Una vez enviado, ingréselo a continuación:</p>
            <div class="form-group">
                <label for="forgotVerificationCode">Código de Verificación:</label>
                <input type="text" id="forgotVerificationCode" maxlength="6" required>
            </div>
            <button class="btn-primary" onclick="verificarCodigoRecuperacion()" tabindex="0">Verificar Código</button>
            <button class="btn-secondary" onclick="cancelForgotPasswordFlow()" tabindex="0">Cancelar</button>
        </section>

        <section id="forgotPasswordCodeSection" class="section hidden-section">
            <h3 class="section-title">Verificar Código de Recuperación</h3>
            <p>Se ha enviado un código de verificación a la dirección:</p>
            <p id="forgotEmailDisplay" style="font-weight: bold; margin-bottom: 1rem;"></p>
            <p>Por favor, ingréselo a continuación:</p>
            <div class="form-group">
                <label for="forgotVerificationCode">Código de Verificación:</label>
                <input type="text" id="forgotVerificationCode" maxlength="6" required>
            </div>
            <button class="btn-primary" onclick="verificarCodigoRecuperacion()" tabindex="0">Verificar Código</button>
            <button class="btn-secondary" onclick="cancelForgotPasswordCodeVerification()" tabindex="0">Cancelar</button>
        </section>

        <section id="forgotPasswordResetSection" class="section hidden-section">
            <h3 class="section-title">Establecer Nueva Contraseña</h3>
            <div class="form-group password-input-wrapper">
                <label for="resetNewPassword">Nueva Contraseña:</label>
                <input type="password" id="resetNewPassword" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('resetNewPassword')" tabindex="0">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <div class="form-group password-input-wrapper">
                <label for="resetConfirmNewPassword">Confirmar Nueva Contraseña:</label>
                <input type="password" id="resetConfirmNewPassword" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('resetConfirmNewPassword')" tabindex="0">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <button class="btn-primary" onclick="establecerNuevaContrasena()" tabindex="0">Guardar Nueva Contraseña</button>
            <button class="btn-secondary" onclick="cancelForgotPasswordReset()" tabindex="0">Cancelar</button>
        </section>

        <section id="developerOptionsSection" class="section hidden-section">
            <h3 class="section-title">Opciones de Desarrollador</h3>
            <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-color-medium);">
                Estas opciones son solo para propósitos de desarrollo y prueba.
            </p>
            <button class="btn-delete" onclick="confirmResetAllData()" tabindex="0">Restablecer Todos los Datos (Developer)</button>
            </section>
        <section id="notificationsSection" class="section">
            <h3 class="section-title">Notificaciones</h3>
            <div class="form-group">
                <input type="checkbox" id="emailNotifications">
                <label for="emailNotifications">Recibir notificaciones por correo electrónico</label>
            </div>
            <button class="btn-primary" onclick="saveNotificationSettings()" tabindex="0">Guardar Ajustes de Notificación</button>
        </section>

        <section id="accountManagementSection" class="section">
            <h3 class="section-title">Gestión de Cuenta</h3>
            <button class="btn-secondary" onclick="cerrarSesion()" tabindex="0">Cerrar Sesión</button>
            <button class="btn-primary btn-delete" onclick="eliminarCuenta()" tabindex="0">Eliminar Cuenta</button>
        </section>
        
        <div id="messageDisplay" class="message"></div>

        <div id="confirmDialog" class="dialog-overlay">
            <div class="dialog-box">
                <p id="dialogMessage"></p>
                <div class="dialog-actions">
                    <button class="btn-secondary" id="dialogCancelBtn" tabindex="0">Cancelar</button>
                    <button class="btn-primary" id="dialogConfirmBtn" tabindex="0">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        // Inicializa EmailJS con tu Public Key
        // Asegúrate de que "DC68SiTk8JF2M4x_a" sea tu Public Key real de EmailJS
        (function() {
            try {
                emailjs.init("DC68SiTk8JF2M4x_a"); // Public Key proporcionada por el usuario
                console.log("EmailJS inicializado correctamente con Public Key: DC68SiTk8JF2M4x_a");
            } catch (e) {
                console.error("Error al inicializar EmailJS. Detalles:", e);
            }
        })();
    </script>
    <script>
        const MIN_PASSWORD_LENGTH = 8;

        let usuarioActivo = localStorage.getItem("usuarioActivo");
        let usuariosRegistrados = getUsuariosRegistrados();
        let emailParaVerificacion = ''; // Usado para el flujo de verificación de correo
        let newEmailToVerify = ''; // Almacena el nuevo email para el flujo de cambio de email
        let emailUsuarioRecuperacion = ''; // Almacena el email para el flujo de recuperación de contraseña

        const EMAILJS_SERVICE_ID = "service_kz355xk"; // Service ID proporcionado por el usuario
        const EMAILJS_TEMPLATE_CODE_VERIFICATION_ID = "template_o3n0xqw"; // Plantilla para códigos de verificación generales (sin cambios)
        const EMAILJS_TEMPLATE_PASSWORD_RECOVERY_ID = "template_8tu2f1r"; // NEW: Plantilla específica para recuperación de contraseña

        // Cargar datos del usuario al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            // Asegúrate de que usuarioActivo y usuariosRegistrados estén cargados ANTES de cargar los datos de UI
            usuarioActivo = localStorage.getItem("usuarioActivo"); // Re-obtener por si acaso
            usuariosRegistrados = getUsuariosRegistrados(); // Re-obtener por si acaso
            cargarDatosUsuario(); // Inicializar opciones de notificación (ejemplo)
            document.getElementById('emailNotifications').checked = true; // La opción de SMS ha sido eliminada, por lo que no la inicializamos

            // NEW: Verificar si se debe mostrar la sección de desarrollador al cargar
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('dev') === 'true') {
                showDeveloperOptions();
            }
        });

        // Rutas SVG para los iconos de ojo (copiadas de Login.html para consistencia)
        const EYE_OPEN_SVG_PATH = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
        const EYE_CLOSED_SVG_PATH = '<path d="M17.43 17.43L12 12l5.43-5.43L17 6l-6 6-5.43-5.43L6 7l6 6 5.43 5.43zM12 4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5s-9.27-3.11-11-7.5c1.73 4.39-6-7.5-11-7.5zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>';

        function getUsuariosRegistrados() {
            try {
                const usuarios = localStorage.getItem("usuariosRegistrados");
                return usuarios ? JSON.parse(usuarios) : {};
            } catch (e) {
                console.error("Error al leer usuariosRegistrados de localStorage:", e);
                return {};
            }
        }

        function guardarUsuariosRegistrados(usuarios) {
            try {
                localStorage.setItem("usuariosRegistrados", JSON.stringify(usuarios));
            } catch (e) {
                console.error("Error al guardar usuariosRegistrados en localStorage:", e);
            }
        }

        function showMessage(msg, type) {
            const msgDisplay = document.getElementById('messageDisplay');
            msgDisplay.textContent = msg;
            msgDisplay.className = `message ${type}`;
            msgDisplay.style.display = 'block';
        }

        function hideAllSections() {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden-section');
            });
            document.getElementById('mainTitle').textContent = "Configuración de Cuenta"; // Reset title
            document.getElementById('messageDisplay').style.display = 'none'; // Ocultar mensajes al cambiar de sección
        }

        function cargarDatosUsuario() {
            // Asegurarse de que usuarioActivo y usuariosRegistrados estén actualizados
            usuarioActivo = localStorage.getItem("usuarioActivo");
            usuariosRegistrados = getUsuariosRegistrados();
            if (usuarioActivo && usuariosRegistrados[usuarioActivo]) {
                const usuario = usuariosRegistrados[usuarioActivo];
                document.getElementById('displayNombre').value = usuario.nombre;
                document.getElementById('displayApellido').value = usuario.apellido;
                document.getElementById('displayEmail').value = usuario.email; // Muestra el correo electrónico
            } else {
                showMessage("No hay sesión activa o su información de usuario no está completa. Por favor, inicie sesión nuevamente.", "error");
                setTimeout(() => window.location.href = 'Login.html', 2000);
            }
        }

        function showProfileEditSection() {
            hideAllSections();
            document.getElementById('userProfileEditSection').classList.remove('hidden-section');
            document.getElementById('mainTitle').textContent = "Editar Perfil";
            // Precargar valores actuales para edición
            document.getElementById('editNombre').value = document.getElementById('displayNombre').value;
            document.getElementById('editApellido').value = document.getElementById('displayApellido').value;
        }

        function cancelProfileEdit() {
            hideAllSections();
            document.getElementById('userProfileSection').classList.remove('hidden-section');
            document.getElementById('securitySection').classList.remove('hidden-section');
            document.getElementById('notificationsSection').classList.remove('hidden-section');
            document.getElementById('accountManagementSection').classList.remove('hidden-section');
            // NEW: Ocultar sección de desarrollador al cancelar edición
            document.getElementById('developerOptionsSection').classList.add('hidden-section');
            showMessage('Edición de perfil cancelada.', 'info');
            cargarDatosUsuario(); // Recargar para asegurar que los campos muestren los datos originales
        }

        function saveProfileChanges() {
            const editNombreInput = document.getElementById('editNombre');
            const editApellidoInput = document.getElementById('editApellido');
            const newNombre = editNombreInput.value.trim();
            const newApellido = editApellidoInput.value.trim();

            // Expresión regular para permitir solo letras (mayúsculas, minúsculas, con tilde) y espacios.
            const nameRegex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;

            // Limpiar errores previos
            editNombreInput.classList.remove('error');
            editApellidoInput.classList.remove('error');
            showMessage('', ''); // Limpiar cualquier mensaje anterior

            let hasErrors = false;
            if (!newNombre || !newApellido) {
                showMessage("Todos los campos (nombre, apellido) son obligatorios.", "error");
                if (!newNombre) marcarError(editNombreInput, true);
                if (!newApellido) marcarError(editApellidoInput, true);
                hasErrors = true;
            } else if (!nameRegex.test(newNombre)) {
                showMessage("El nombre solo puede contener letras y espacios.", "error");
                marcarError(editNombreInput, true);
                hasErrors = true;
            } else if (!nameRegex.test(newApellido)) {
                showMessage("El apellido solo puede contener letras y espacios.", "error");
                marcarError(editApellidoInput, true);
                hasErrors = true;
            }

            if (hasErrors) {
                return;
            }

            if (usuariosRegistrados[usuarioActivo]) {
                usuariosRegistrados[usuarioActivo].nombre = newNombre;
                usuariosRegistrados[usuarioActivo].apellido = newApellido;
                guardarUsuariosRegistrados(usuariosRegistrados);
                cargarDatosUsuario(); // Actualizar la interfaz de usuario con los nuevos datos
                showMessage("Cambios de perfil guardados con éxito.", "success");
                setTimeout(() => cancelProfileEdit(), 2000); // Volver a la vista principal después de un tiempo
            }
        }

        // Funciones de seguridad
        function showChangePasswordFlow() {
            hideAllSections();
            document.getElementById('changePasswordSection').classList.remove('hidden-section');
            document.getElementById('mainTitle').textContent = "Cambiar Contraseña";
            // Limpiar campos de contraseña al mostrar la sección
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        function cancelChangePassword() {
            hideAllSections();
            document.getElementById('userProfileSection').classList.remove('hidden-section');
            document.getElementById('securitySection').classList.remove('hidden-section');
            document.getElementById('notificationsSection').classList.remove('hidden-section');
            document.getElementById('accountManagementSection').classList.remove('hidden-section');
            // NEW: Ocultar sección de desarrollador al cancelar cambio de contraseña
            document.getElementById('developerOptionsSection').classList.add('hidden-section');
            showMessage('Cambio de contraseña cancelado.', 'info');
        }

        function changePassword() {
            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            // Limpiar errores previos
            currentPasswordInput.classList.remove('error');
            newPasswordInput.classList.remove('error');
            confirmNewPasswordInput.classList.remove('error');
            showMessage('', '');

            let hasErrors = false;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showMessage("Todos los campos de contraseña son obligatorios.", "error");
                if (!currentPassword) marcarError(currentPasswordInput, true);
                if (!newPassword) marcarError(newPasswordInput, true);
                if (!confirmNewPassword) marcarError(confirmNewPasswordInput, true);
                hasErrors = true;
            }

            if (newPassword.length < MIN_PASSWORD_LENGTH) {
                showMessage(`La nueva contraseña debe tener al menos ${MIN_PASSWORD_LENGTH} caracteres.`, "error");
                marcarError(newPasswordInput, true);
                hasErrors = true;
            }

            if (newPassword !== confirmNewPassword) {
                showMessage("La nueva contraseña y la confirmación no coinciden.", "error");
                marcarError(newPasswordInput, true);
                marcarError(confirmNewPasswordInput, true);
                hasErrors = true;
            }

            if (hasErrors) {
                return;
            }

            if (usuariosRegistrados[usuarioActivo] && usuariosRegistrados[usuarioActivo].password === currentPassword) {
                usuariosRegistrados[usuarioActivo].password = newPassword;
                guardarUsuariosRegistrados(usuariosRegistrados);
                showMessage("Contraseña cambiada con éxito.", "success");
                setTimeout(() => cancelChangePassword(), 2000);
            } else {
                showMessage("Contraseña actual incorrecta.", "error");
                marcarError(currentPasswordInput, true);
            }
        }

        // --- Flujo de Verificación de Correo Electrónico Actual ---
        function iniciarVerificacionCorreo() {
            hideAllSections();
            document.getElementById('verificationEmailSection').classList.remove('hidden-section');
            document.getElementById('mainTitle').textContent = "Verificar Correo Electrónico Actual";
            emailParaVerificacion = usuariosRegistrados[usuarioActivo].email;
            document.getElementById('emailToVerifyDisplay').textContent = emailParaVerificacion;
            document.getElementById('emailVerificationCode').value = ''; // Limpiar campo de código
            showMessage('', ''); // Limpiar mensajes
        }

        async function enviarCodigoVerificacionActual() {
            showMessage("Enviando código...", "info");
            try {
                const response = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CODE_VERIFICATION_ID, {
                    user_email: emailParaVerificacion,
                    verification_code: generarCodigoVerificacion(),
                });
                console.log('EmailJS response:', response);
                showMessage("Código de verificación enviado a tu correo actual.", "success");
            } catch (error) {
                console.error('Error al enviar el correo con EmailJS:', error);
                showMessage("Error al enviar el código de verificación. Inténtalo de nuevo.", "error");
            }
        }

        function verificarCodigoCorreo() {
            const inputCode = document.getElementById('emailVerificationCode').value.trim();
            const storedCode = localStorage.getItem('lastVerificationCode');

            document.getElementById('emailVerificationCode').classList.remove('error');
            showMessage('', '');

            if (!inputCode) {
                showMessage("Por favor, introduce el código de verificación.", "error");
                marcarError(document.getElementById('emailVerificationCode'), true);
                return;
            }

            if (inputCode === storedCode) {
                showMessage("Correo electrónico verificado con éxito.", "success");
                localStorage.removeItem('lastVerificationCode'); // Limpiar código
                setTimeout(() => cancelarVerificacionCorreo(), 2000);
            } else {
                showMessage("Código de verificación incorrecto. Inténtalo de nuevo.", "error");
                marcarError(document.getElementById('emailVerificationCode'), true);
            }
        }

        function cancelarVerificacionCorreo() {
            hideAllSections();
            document.getElementById('userProfileSection').classList.remove('hidden-section');
            document.getElementById('securitySection').classList.remove('hidden-section');
            document.getElementById('notificationsSection').classList.remove('hidden-section');
            document.getElementById('accountManagementSection').classList.remove('hidden-section');
             // NEW: Ocultar sección de desarrollador al cancelar verificación de correo
            document.getElementById('developerOptionsSection').classList.add('hidden-section');
            showMessage('Verificación de correo cancelada.', 'info');
        }

        // --- Flujo de Cambio de Correo Electrónico ---
        function showChangeEmailFlow() {
            hideAllSections();
            document.getElementById('changeEmailSection').classList.remove('hidden-section');
            document.getElementById('mainTitle').textContent = "Cambiar Correo Electrónico";
            document.getElementById('newEmail').value = '';
            document.getElementById('newEmailVerificationCode').value = '';
            showMessage('', '');
        }

        async function enviarCodigoNuevoCorreo() {
            const newEmailInput = document.getElementById('newEmail');
            newEmailToVerify = newEmailInput.value.trim();

            newEmailInput.classList.remove('error');
            showMessage('', '');

            if (!newEmailToVerify || !isValidEmail(newEmailToVerify)) {
                showMessage("Por favor, introduce un nuevo correo electrónico válido.", "error");
                marcarError(newEmailInput, true);
                return;
            }

            // Verificar si el nuevo correo ya está registrado por otro usuario
            const usuarios = getUsuariosRegistrados();
            for (const key in usuarios) {
                if (usuarios[key].email === newEmailToVerify && key !== usuarioActivo) {
                    showMessage("Este correo electrónico ya está registrado por otra cuenta.", "error");
                    marcarError(newEmailInput, true);
                    return;
                }
            }

            showMessage("Enviando código...", "info");
            try {
                const response = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CODE_VERIFICATION_ID, {
                    user_email: newEmailToVerify,
                    verification_code: generarCodigoVerificacion(),
                });
                console.log('EmailJS response:', response);
                showMessage(`Código enviado a ${newEmailToVerify}. Por favor, verifícalo.`, "success");
                // Una vez enviado el código, puedes pasar a la sección de verificación (opcional, o el usuario lo ingresa en la misma sección)
            } catch (error) {
                console.error('Error al enviar el correo con EmailJS:', error);
                showMessage("Error al enviar el código de verificación. Inténtalo de nuevo.", "error");
            }
        }

        function verificarCodigoNuevoCorreo() {
            const inputCode = document.getElementById('newEmailVerificationCode').value.trim();
            const storedCode = localStorage.getItem('lastVerificationCode');

            document.getElementById('newEmailVerificationCode').classList.remove('error');
            showMessage('', '');

            if (!inputCode) {
                showMessage("Por favor, introduce el código de verificación.", "error");
                marcarError(document.getElementById('newEmailVerificationCode'), true);
                return;
            }

            if (inputCode === storedCode) {
                // Actualizar el correo electrónico del usuario activo
                if (usuariosRegistrados[usuarioActivo]) {
                    const oldEmail = usuariosRegistrados[usuarioActivo].email;
                    usuariosRegistrados[newEmailToVerify] = { ...usuariosRegistrados[usuarioActivo], email: newEmailToVerify };
                    delete usuariosRegistrados[oldEmail]; // Eliminar la entrada antigua
                    localStorage.setItem("usuarioActivo", newEmailToVerify); // Actualizar usuario activo
                    guardarUsuariosRegistrados(usuariosRegistrados);

                    showMessage("Correo electrónico cambiado y verificado con éxito.", "success");
                    localStorage.removeItem('lastVerificationCode'); // Limpiar código
                    cargarDatosUsuario(); // Recargar datos en la UI
                    setTimeout(() => cancelChangeEmail(), 2000);
                }
            } else {
                showMessage("Código de verificación incorrecto. Inténtalo de nuevo.", "error");
                marcarError(document.getElementById('newEmailVerificationCode'), true);
            }
        }

        function cancelChangeEmail() {
            hideAllSections();
            document.getElementById('userProfileSection').classList.remove('hidden-section');
            document.getElementById('securitySection').classList.remove('hidden-section');
            document.getElementById('notificationsSection').classList.remove('hidden-section');
            document.getElementById('accountManagementSection').classList.remove('hidden-section');
            // NEW: Ocultar sección de desarrollador al cancelar cambio de email
            document.getElementById('developerOptionsSection').classList.add('hidden-section');
            showMessage('Cambio de correo electrónico cancelado.', 'info');
        }

        function cancelVerifyNewEmail() {
            hideAllSections();
            document.getElementById('userProfileSection').classList.remove('hidden-section');
            document.getElementById('securitySection').classList.remove('hidden-section');
            document.getElementById('notificationsSection').classList.remove('hidden-section');
            document.getElementById('accountManagementSection').classList.remove('hidden-section');
            // NEW: Ocultar sección de desarrollador al cancelar verificación de nuevo email
            document.getElementById('developerOptionsSection').classList.add('hidden-section');
            showMessage('Verificación de nuevo correo electrónico cancelada.', 'info');
        }

        // --- Flujo de Recuperación de Contraseña ---
        function showForgotPasswordFlow() {
            hideAllSections();
            document.getElementById('forgotPasswordEmailSection').classList.remove('hidden-section');
            document.getElementById('mainTitle').textContent = "Recuperar Contraseña";
            // Pre-llenar el campo de correo con el email activo (si existe)
            document.getElementById('forgotEmail').value = usuariosRegistrados[usuarioActivo] ? usuariosRegistrados[usuarioActivo].email : '';
            document.getElementById('forgotVerificationCode').value = '';
            showMessage('', '');
        }

        async function enviarCodigoRecuperacion() {
            emailUsuarioRecuperacion = document.getElementById('forgotEmail').value.trim();
            const forgotEmailInput = document.getElementById('forgotEmail');

            forgotEmailInput.classList.remove('error');
            showMessage('', '');

            if (!emailUsuarioRecuperacion || !isValidEmail(emailUsuarioRecuperacion)) {
                showMessage("Por favor, introduce un correo electrónico válido para la recuperación.", "error");
                marcarError(forgotEmailInput, true);
                return;
            }

            // Verificar si el correo existe en los usuarios registrados
            const userExists = Object.values(usuariosRegistrados).some(user => user.email === emailUsuarioRecuperacion);
            if (!userExists) {
                showMessage("No hay una cuenta registrada con este correo electrónico.", "error");
                marcarError(forgotEmailInput, true);
                return;
            }

            showMessage("Enviando código de recuperación...", "info");
            try {
                const response = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_PASSWORD_RECOVERY_ID, {
                    user_email: emailUsuarioRecuperacion,
                    recovery_code: generarCodigoVerificacion(), // Reutilizar la función de generación de código
                });
                console.log('EmailJS response (password recovery):', response);
                showMessage(`Código de recuperación enviado a ${emailUsuarioRecuperacion}.`, "success");
                // Mostrar la sección de verificación de código de recuperación
                setTimeout(() => showForgotPasswordCodeVerification(), 1000);
            } catch (error) {
                console.error('Error al enviar el correo de recuperación con EmailJS:', error);
                showMessage("Error al enviar el código de recuperación. Inténtalo de nuevo.", "error");
            }
        }

        function showForgotPasswordCodeVerification() {
            hideAllSections();
            document.getElementById('forgotPasswordCodeSection').classList.remove('hidden-section');
            document.getElementById('mainTitle').textContent = "Verificar Código de Recuperación";
            document.getElementById('forgotEmailDisplay').textContent = emailUsuarioRecuperacion;
            document.getElementById('forgotVerificationCode').value = ''; // Limpiar campo de código
            showMessage('', '');
        }

        function verificarCodigoRecuperacion() {
            const inputCode = document.getElementById('forgotVerificationCode').value.trim();
            const storedCode = localStorage.getItem('lastVerificationCode');

            document.getElementById('forgotVerificationCode').classList.remove('error');
            showMessage('', '');

            if (!inputCode) {
                showMessage("Por favor, introduce el código de recuperación.", "error");
                marcarError(document.getElementById('forgotVerificationCode'), true);
                return;
            }

            if (inputCode === storedCode) {
                showMessage("Código verificado. Ahora puedes establecer una nueva contraseña.", "success");
                localStorage.removeItem('lastVerificationCode'); // Limpiar código
                setTimeout(() => showForgotPasswordReset(), 1000);
            } else {
                showMessage("Código de recuperación incorrecto. Inténtalo de nuevo.", "error");
                marcarError(document.getElementById('forgotVerificationCode'), true);
            }
        }

        function showForgotPasswordReset() {
            hideAllSections();
            document.getElementById('forgotPasswordResetSection').classList.remove('hidden-section');
            document.getElementById('mainTitle').textContent = "Establecer Nueva Contraseña";
            document.getElementById('resetNewPassword').value = '';
            document.getElementById('resetConfirmNewPassword').value = '';
            showMessage('', '');
        }

        function establecerNuevaContrasena() {
            const resetNewPasswordInput = document.getElementById('resetNewPassword');
            const resetConfirmNewPasswordInput = document.getElementById('resetConfirmNewPassword');

            const newPassword = resetNewPasswordInput.value;
            const confirmNewPassword = resetConfirmNewPasswordInput.value;

            // Limpiar errores previos
            resetNewPasswordInput.classList.remove('error');
            resetConfirmNewPasswordInput.classList.remove('error');
            showMessage('', '');

            let hasErrors = false;

            if (!newPassword || !confirmNewPassword) {
                showMessage("Todos los campos de nueva contraseña son obligatorios.", "error");
                if (!newPassword) marcarError(resetNewPasswordInput, true);
                if (!confirmNewPassword) marcarError(resetConfirmNewPasswordInput, true);
                hasErrors = true;
            }

            if (newPassword.length < MIN_PASSWORD_LENGTH) {
                showMessage(`La nueva contraseña debe tener al menos ${MIN_PASSWORD_LENGTH} caracteres.`, "error");
                marcarError(resetNewPasswordInput, true);
                hasErrors = true;
            }

            if (newPassword !== confirmNewPassword) {
                showMessage("La nueva contraseña y la confirmación no coinciden.", "error");
                marcarError(resetNewPasswordInput, true);
                marcarError(resetConfirmNewPasswordInput, true);
                hasErrors = true;
            }

            if (hasErrors) {
                return;
            }

            // Encontrar el usuario por el email de recuperación
            let userFound = false;
            for (const key in usuariosRegistrados) {
                if (usuariosRegistrados[key].email === emailUsuarioRecuperacion) {
                    usuariosRegistrados[key].password = newPassword;
                    guardarUsuariosRegistrados(usuariosRegistrados);
                    userFound = true;
                    break;
                }
            }

            if (userFound) {
                showMessage("Contraseña restablecida con éxito. Puedes iniciar sesión con tu nueva contraseña.", "success");
                setTimeout(() => window.location.href = 'Login.html', 2000); // Redirigir al login
            } else {
                showMessage("Error: No se pudo encontrar el usuario para restablecer la contraseña.", "error");
            }
        }

        function cancelForgotPasswordFlow() {
            hideAllSections();
            document.getElementById('userProfileSection').classList.remove('hidden-section');
            document.getElementById('securitySection').classList.remove('hidden-section');
            document.getElementById('notificationsSection').classList.remove('hidden-section');
            document.getElementById('accountManagementSection').classList.remove('hidden-section');
            // NEW: Ocultar sección de desarrollador al cancelar recuperación de contraseña
            document.getElementById('developerOptionsSection').classList.add('hidden-section');
            showMessage('Recuperación de contraseña cancelada.', 'info');
        }

        function cancelForgotPasswordCodeVerification() {
            hideAllSections();
            document.getElementById('userProfileSection').classList.remove('hidden-section');
            document.getElementById('securitySection').classList.remove('hidden-section');
            document.getElementById('notificationsSection').classList.remove('hidden-section');
            document.getElementById('accountManagementSection').classList.remove('hidden-section');
            // NEW: Ocultar sección de desarrollador al cancelar verificación de código de recuperación
            document.getElementById('developerOptionsSection').classList.add('hidden-section');
            showMessage('Verificación de código de recuperación cancelada.', 'info');
        }

        function cancelForgotPasswordReset() {
            hideAllSections();
            document.getElementById('userProfileSection').classList.remove('hidden-section');
            document.getElementById('securitySection').classList.remove('hidden-section');
            document.getElementById('notificationsSection').classList.remove('hidden-section');
            document.getElementById('accountManagementSection').classList.remove('hidden-section');
            // NEW: Ocultar sección de desarrollador al cancelar restablecimiento de contraseña
            document.getElementById('developerOptionsSection').classList.add('hidden-section');
            showMessage('Restablecimiento de contraseña cancelado.', 'info');
        }


        // Funciones de notificación
        function saveNotificationSettings() {
            const emailNotifications = document.getElementById('emailNotifications').checked;
            // Aquí guardarías las preferencias en localStorage o en un servidor
            if (usuariosRegistrados[usuarioActivo]) {
                usuariosRegistrados[usuarioActivo].emailNotifications = emailNotifications;
                guardarUsuariosRegistrados(usuariosRegistrados);
                showMessage("Ajustes de notificación guardados.", "success");
            } else {
                showMessage("Error al guardar los ajustes de notificación.", "error");
            }
        }

        // Funciones de gestión de cuenta
        function cerrarSesion() {
            localStorage.removeItem("sesionIniciada");
            localStorage.removeItem("usuarioActivo");
            showMessage("Sesión cerrada correctamente.", "success");
            setTimeout(() => window.location.href = 'Login.html', 1000);
        }

        function eliminarCuenta() {
            showConfirmDialog("¿Estás seguro de que quieres eliminar tu cuenta? Esta acción es irreversible.", () => {
                if (usuariosRegistrados[usuarioActivo]) {
                    delete usuariosRegistrados[usuarioActivo];
                    guardarUsuariosRegistrados(usuariosRegistrados);
                    localStorage.removeItem("sesionIniciada");
                    localStorage.removeItem("usuarioActivo");
                    showMessage("Tu cuenta ha sido eliminada permanentemente.", "success");
                    setTimeout(() => window.location.href = 'Login.html', 2000);
                }
            });
        }

        // Funciones de utilidad
        function generarCodigoVerificacion() {
            const code = Math.floor(100000 + Math.random() * 900000).toString(); // Código de 6 dígitos
            localStorage.setItem('lastVerificationCode', code); // Guardar temporalmente el código
            console.log("Generated Verification Code (for dev/test):", code); // Para propósitos de depuración
            return code;
        }

        function isValidEmail(email) {
            // Expresión regular simple para validación de email
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const iconContainer = input.nextElementSibling;
            if (input.type === "password") {
                input.type = "text";
                iconContainer.innerHTML = `<i class="fas fa-eye-slash"></i>`;
            } else {
                input.type = "password";
                iconContainer.innerHTML = `<i class="fas fa-eye"></i>`;
            }
        }

        function marcarError(element, isError) {
            if (isError) {
                element.classList.add('error');
            } else {
                element.classList.remove('error');
            }
        }

        // --- Diálogos de Confirmación ---
        let confirmActionCallback = null;

        function showConfirmDialog(message, callback) {
            document.getElementById('dialogMessage').textContent = message;
            document.getElementById('confirmDialog').classList.add('show');
            confirmActionCallback = callback;
        }

        function hideConfirmDialog() {
            document.getElementById('confirmDialog').classList.remove('show');
            confirmActionCallback = null;
        }

        document.getElementById('dialogConfirmBtn').addEventListener('click', () => {
            if (confirmActionCallback) {
                confirmActionCallback();
            }
            hideConfirmDialog();
        });

        document.getElementById('dialogCancelBtn').addEventListener('click', () => {
            hideConfirmDialog();
            showMessage('Operación cancelada.', 'info'); // Opcional: mostrar un mensaje de cancelación
        });

        // Manejo global de la tecla Esc para cerrar diálogos
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (document.getElementById('confirmDialog').classList.contains('show')) {
                    hideConfirmDialog();
                }
            }
        });

        // --- Navegación y flecha de retroceso ---
        function goBack() {
            const currentTitle = document.getElementById('mainTitle').textContent;
            
            if (currentTitle === "Editar Perfil") {
                cancelProfileEdit();
            } else if (currentTitle === "Cambiar Contraseña") {
                cancelChangePassword();
            } else if (currentTitle === "Verificar Correo Electrónico Actual") {
                cancelarVerificacionCorreo();
            } else if (currentTitle === "Cambiar Correo Electrónico") {
                cancelChangeEmail();
            } else if (currentTitle === "Verificar Nuevo Correo Electrónico") {
                cancelVerifyNewEmail();
            } else if (currentTitle === "Recuperar Contraseña") { // NEW
                cancelForgotPasswordFlow();
            } else if (currentTitle === "Verificar Código de Recuperación") { // NEW
                cancelForgotPasswordCodeVerification();
            } else if (currentTitle === "Establecer Nueva Contraseña") { // NEW
                cancelForgotPasswordReset();
            } else if (currentTitle === "Opciones de Desarrollador") { // NEW
                hideAllSections();
                document.getElementById('userProfileSection').classList.remove('hidden-section');
                document.getElementById('securitySection').classList.remove('hidden-section');
                document.getElementById('notificationsSection').classList.remove('hidden-section');
                document.getElementById('accountManagementSection').classList.remove('hidden-section');
                document.getElementById('mainTitle').textContent = "Configuración de Cuenta";
            } else {
                history.back();
            }
        }

        // Manejo global de la tecla Enter para accesibilidad
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const activeElement = document.activeElement;

                // Si el elemento activo es un botón
                if (activeElement && activeElement.tagName === 'BUTTON') {
                    activeElement.click();
                    event.preventDefault();
                }
                
                // Si el elemento activo es un div o span con un onclick y tabindex
                if (activeElement && (activeElement.tagName === 'DIV' || activeElement.tagName === 'SPAN') && activeElement.hasAttribute('tabindex') && activeElement.onclick) {
                    activeElement.click();
                    event.preventDefault();
                }
            }
        });

        // NEW: Funciones de Opciones de Desarrollador
        function showDeveloperOptions() {
            hideAllSections();
            document.getElementById('developerOptionsSection').classList.remove('hidden-section');
            document.getElementById('mainTitle').textContent = "Opciones de Desarrollador";
            showMessage("Advertencia: Las opciones de desarrollador pueden eliminar datos y afectar el comportamiento de la aplicación.", "warning");
        }

        function confirmResetAllData() {
            showConfirmDialog("Esta acción eliminará TODOS los datos de usuario y sesión de tu navegador (localStorage). ¿Estás seguro?", () => {
                resetAllData();
            });
        }

        function resetAllData() {
            console.warn("RESTABLECIENDO TODOS LOS DATOS DE USUARIO Y SESIÓN POR SOLICITUD DE DESARROLLADOR.");
            localStorage.clear();
            showMessage("Todos los datos han sido restablecidos. Redirigiendo...", "success");
            // Opcional: Recargar la página o redirigir a Login.html
            setTimeout(() => window.location.href = 'Login.html', 1500);
        }

    </script>
</body>
</html>